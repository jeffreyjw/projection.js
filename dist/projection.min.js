
/*
 * -------------------------------------------------------
 * Project: projection.js
 * Version: 0.1.0
 *
 * Author:  jeffreyjw
 * Site:     https://github.com/jeffreyjw
 * Contact: jjwojtczak@gmail.com
 *
 *
 * Copyright (c) 2014 jeffreyjw
 * -------------------------------------------------------
 */

"use strict";var PROJECTION;PROJECTION=PROJECTION||{};var PropertyObject;PropertyObject=function(){function PropertyObject(){}return PropertyObject.property=function(propertyName,descriptor){return Object.defineProperty(this.prototype,propertyName,descriptor)},PropertyObject}();var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};PROJECTION.Camera=function(_super){function Camera(){this.fieldOfView=45,this.aspectRatio=1.6,this.zNear=1,this.zFar=100,this.position=[0,0,1],this.lookAt=[0,0,0],this.up=[0,1,0],this.projectionMatrix=mat4.create(),this.viewMatrix=mat4.create(),this._dirtyModel=!0,this._dirtyView=!0}return __extends(Camera,_super),Camera.prototype._dirtyModel=null,Camera.prototype._dirtyView=null,Camera.prototype._fieldOfView=null,Camera.property("fieldOfView",{get:function(){return this._fieldOfView},set:function(value){return this._fieldOfView=value,this._dirtyView=!0}}),Camera.prototype._aspectRatio=null,Camera.property("aspectRatio",{get:function(){return this._aspectRatio},set:function(value){return this._aspectRatio=value,this._dirtyView=!0}}),Camera.prototype._zNear=null,Camera.property("zNear",{get:function(){return this._zNear},set:function(value){return this._zNear=value,this._dirtyView=!0}}),Camera.prototype._zFar=null,Camera.property("zFar",{get:function(){return this._zFar},set:function(value){return this._zFar=value,this._dirtyView=!0}}),Camera.prototype._position=null,Camera.property("position",{get:function(){return this._position},set:function(value){return this._position=value,this._dirtyModel=!0}}),Camera.prototype._lookAt=null,Camera.prototype._lookAtNode=null,Camera.property("lookAt",{get:function(){return this._lookAt},set:function(value){return value instanceof Node?(this._lookAtNode=value,this._lookAt=this._lookAtNode.position):(this._lookAtNode=null,this._lookAt=value),this._dirtyModel=!0}}),Camera.prototype._up=null,Camera.property("up",{get:function(){return this._up},set:function(value){return this._up=value,this._dirtyModel=!0}}),Camera.prototype.projectionMatrix=null,Camera.prototype.viewMatrix=null,Camera.prototype._updateView=function(){return mat4.perspective(this.projectionMatrix,this.fieldOfView,this.aspectRatio,this.zNear,this.zFar)},Camera.prototype._updateModel=function(){return mat4.lookAt(this.viewMatrix,this.position,this._lookAt,this.up)},Camera.prototype.transform=function(vec,modelMatrix){var outVec;return this._dirtyModel&&(this._updateModel(),this._dirtyModel=!1),this._dirtyView&&(this._updateView(),null===this._lookAtNode&&(this._dirtyView=!1)),outVec=vec3.create(),vec3.transformMat4(outVec,vec,modelMatrix),vec3.transformMat4(outVec,outVec,this.viewMatrix),vec3.transformMat4(outVec,outVec,this.projectionMatrix),outVec},Camera}(PropertyObject),PROJECTION.Node=function(){function Node(parent){null==parent&&(parent=null),this.parent=parent,this.children=[],parent&&this.parent.children.push(this),this.matrix=mat4.create(),this.position=vec3.create(),this.rotation=[0,0,0],this._identity=mat4.create()}return Node.prototype.position=null,Node.prototype.scale=0,Node.prototype.rotation=null,Node.prototype.parent=null,Node.prototype.children=null,Node.prototype.matrix=null,Node.prototype._identity=null,Node.prototype.update=function(){var child,index,_i,_len,_ref;for(mat4.translate(this.matrix,this._parentMatrix(),this.position),mat4.rotateX(this.matrix,this.matrix,this.rotation[0]),mat4.rotateY(this.matrix,this.matrix,this.rotation[1]),mat4.rotateZ(this.matrix,this.matrix,this.rotation[2]),_ref=this.children,index=_i=0,_len=_ref.length;_len>_i;index=++_i)child=_ref[index],child.parent===this?child.update():this.children[index]=null;return this.children=this.children.filter(function(child){return null!==child})},Node.prototype._parentMatrix=function(){return null!==this.parent?this.parent.matrix:this._identity},Node.prototype.getData2d=function(camera){var out,vec;return out={position:null,scale:null},vec=camera.transform(this.position,this._parentMatrix()),0===vec[2]?(out.position=[0,0],out.scale=0):(out.scale=1/vec[2],out.position=[vec[0]*out.scale,vec[1]*out.scale]),out},Node}();